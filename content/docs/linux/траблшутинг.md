# Траблшутинг серверов Linux

Ниже приведены команды для анализа сервера в той или иной ситуации.

## Состояние дисков

### Проверка оставшегося места на жестких дисках

```bash
df -h # Можно сделать alias df="df -h"
```

Если надо в inode:

```bash
df -i
```

### Проверка сколько места занимает тот или иной файл

Команда ниже, например, выводит информацию обо всех файлах в /tmp.

```bash
sudo du -h /tmp/*
```

### Анализ жестних дисков(которые ни Nvme, ни SSD)

Для этого используются Self-Monitoring, Analysis and Reporting Technology, или по-простому SMART.

```bash
sudo apt-get install -y smartmontools
sudo smartctl -a /dev/sdb
```

Утилиту smartctl можно использовать и на NVme, SSD дисках, но там будут использоваться не SMART-контракты.
Так как их нету у такого типа дисков, утилита просто соберет информацию, которой обладает система.

### Просмотр информации о raid-ах

Нужную информацию о raid-ах можно узнать командой ниже:

```bash
cat /proc/mdstat
```

## Нагрузка на CPU, RAM, диски

Для начала надо установить необходимые пакеты.

```bash
sudo apt-get install -y sysstat iotop
```

### Нагрузка на диски

Тут есть две команды, которые надо знать iostat и iotop.

**iostat** - используется для вывода информации о загруженности диска.

**iotop** - выводит информацию о процессах, что взаимодействуют с диском.

```bash
iostat
sudo iotop
```

### Утилита top

1. %CPU(s) - режимы работы процессора(us - пользовательский режим, system - для ядра, nice - процессы с измененным приоритетом, idle - простой, wait - ожидание завершения I/O, hardware и software - прерывания, steel - украденное время гипервизором)
2. Load Average - показывает среднее время выполнения процессов, а также ввода/вывода


### Память

Всю информацию о памяти можно посмотреть в файле /proc/meminfo.

Также можно использовать:

- `free -m`
- `vmstat`
- `top`

## Процессы

Чтобы просмотреть все процессы можно использовать команду ниже:

```bash
ps aux
```

Можно просмотреть статус определенного демона:

```bash
systemctl status docker
```

Чтобы отдебажить процессы и найти проблему, можно использовать `strace`

## Сети

### Анализ сетевых процессов

Установка утилит:

```bash
sudo apt-get install -y net-tools
```

Чтобы просмотреть информацию по сетевым процессам:

```bash
netstat -tulpn

# or

ss -lntu
```

### Инфомацию о сетевых интерфейсах

Банальный `ip a` или `ifconfig`.

### Информация о сетевых маршрутах

Чтобы просмотреть необходимую информацию нужно использовать команду ниже:

```bash
netstat -rn

# or
ip r
```

### Диагностика сети

1. Через команду `ping` можно проверить dns resolving.
2. Команда `traceroute` показывает путь пакетов.
3. Через команду `mtr` можно проделать аналогичное команде `traceroute`, но в живую. И просматреть где теряются пакеты.
4. Через команду `dig` можно просмотреть DNS.
5. Через команду `tcpdump` можно проверить доступность пакетов и доходят ли они.

## Логи

Зачастую логи хранятся в /var/log.

### Логи от ядра Linux

Чтобы просмотрить логи ядра:

```bash
sudo dmesg -T
```
